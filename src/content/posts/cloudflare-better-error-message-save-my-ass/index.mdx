---
title: Cloudflare API's better error message save my ass
description: è®°ä¸€æ¬¡åœ¨å·¥ä½œä¸­é‡åˆ°çš„é—®é¢˜
published: true
listed: true
createdAt: '2023-12-18' 
updatedAt: '2023-12-18' 
publishedAt: '2023-12-18'
tags:
  - dev/null
---

å‡ ä¸ªæ˜ŸæœŸå‰ï¼Œæˆ‘æ¥åˆ°ä¸€ä¸ªä»»åŠ¡æ˜¯è¦é€šè¿‡ CI/CD æŠŠæˆ‘ä»¬çš„åº”ç”¨é€šè¿‡æˆ‘ä»¬çš„æ„å»ºæœºå™¨æ‰“åŒ…ğŸ“¦ï¼Œå¹¶ä¸”åœ¨æ‰“åŒ…å®Œæˆåå°†å®ƒæ¨é€åˆ° AWS çš„ S3 å­˜å‚¨ã€‚

å½“æˆ‘æŠŠæ•´ä¸ª CI/CD çš„æ„å»ºè®¡åˆ’å®Œæ•´çš„å¼„å¥½ä»¥åï¼Œæˆ‘æ»¡æ€€æœŸå¾…çš„ä¸‹è½½åº”ç”¨ä¸‹æ¥å®‰è£…æ ¡éªŒæ–°çš„ commit æ˜¯å¦æœ‰æ•ˆçš„æ—¶å€™ï¼Œå´å‘ç°å°½ç®¡ CI/CD ä¸Šæ˜¾ç¤ºçš„æ˜¯ç”¨çš„æœ€æ–°çš„ commit æ¥æ‰“åŒ…ï¼Œä½†æ˜¯åº”ç”¨å®‰è£…å®Œåæ‰“å¼€å´å¹¶æ²¡æœ‰çœ‹åˆ°é¢„æœŸçš„æ•ˆæœï¼Œå³ä½¿æˆ‘æ–°æ‰“å¼€ä¸€ä¸ªæ— ç—•æµè§ˆå™¨ä¸‹è½½ä¹Ÿæ˜¯ä¸€æ ·ã€‚

å› ä¸ºåœ¨ç°ä»£ Web å¼€å‘ä¸­ï¼Œé™¤äº†æµè§ˆå™¨çš„ç¼“å­˜ï¼ˆBrowser Cacheï¼‰ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ç§ç¼“å­˜ CDN ç¼“å­˜ã€‚

åƒæˆ‘è¿™æ¬¡é‡åˆ°çš„é—®é¢˜å°±æ˜¯å› ä¸ºä¸Šä¼ çš„åº”ç”¨æ˜¯ä¼ åˆ°äº† Amazon çš„ S3 å­˜å‚¨ã€‚è€Œ CDN æœåŠ¡æ˜¯ Cloudflare çš„ã€‚

é—®é¢˜å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨åº”ç”¨ä¼ ä¸Šå»ååˆ·æ–° CDN ç¼“å­˜å°±å¥½ã€‚

ä½†å…¬å¸çš„ Cloudflare è´¦å·åªæœ‰ä¸€ä¸ªï¼Œä¸åƒ Amazon é‚£æ ·å¯ä»¥é€šè¿‡ AWS Identity and Access Management æ¥åˆ›å»ºä¸€ä¸ªè´¦å·é’ˆå¯¹æŸé¡¹èµ„æºåšæ“ä½œã€‚

æ¯æ¬¡ CI/CD å®Œæˆåè¿˜è¦äººå·¥å»åˆ·æ–°ç¼“å­˜å¥½åƒä¹Ÿä¸æ˜¯é‚£ä¹ˆçš„å¾ˆè‡ªåŠ¨åŒ–ğŸ¤”ã€‚

ğŸ’¡ é€šè¿‡ token è°ƒç”¨ Cloudflare çš„ API æ¥å®ç°åˆ·æ–°ç¼“å­˜ã€‚åªéœ€è¦ä¸€ä¸ª curl å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ğŸ˜„ï¼Œè½»æ¾åŠ æ„‰å¿«ã€‚

ä½†æ˜¯æ–‡æ¡£é‡Œé¢æ‰¾åˆ°è¿™ä¸ªåˆ·æ–°ç¼“å­˜çš„ api åçœŸæ­£è°ƒç”¨èµ·æ¥å´é‡åˆ°äº†é—®é¢˜ã€‚

[Purge Cached Content](https://developers.cloudflare.com/api/operations/zone-purge) è¿™ä¸ª API è™½ç„¶çœ‹æè¿°è¯´å¯ä»¥æ¸…ç©ºç¼“å­˜ï¼Œä½†æ˜¯çœ‹å®ƒæ‰€æ”¯æŒçš„å‚æ•°ï¼Œå¥½åƒå¹¶ä¸æ”¯æŒåˆ·æ–°æŒ‡å®šæ–‡ä»¶ï¼Œæˆ‘ä¸æƒ³åˆ·æ–°æ‰€æœ‰ç¼“å­˜ï¼Œæ¯•ç«Ÿæˆ‘åªæ˜¯ä¸Šä¼ äº†å‡ ä¸ªåº”ç”¨çš„å®‰è£…åŒ…åˆ° S3 ä¸Šã€‚
ä½†æ˜¯åœ¨ Cloudflare çš„ Custom Purge é¡µé¢ä¸Šæ˜¯å¯ä»¥æ”¯æŒåˆ·æ–°ç‰¹å®š URL çš„ã€‚

![cloudflare-custom-purge-page](cloudflare-custom-purge.png)

å°±åœ¨ä¸€ç­¹è«å±•ï¼Œå‡†å¤‡å®åœ¨ä¸è¡Œé‚£æˆ‘å°±æ•´ä¸ªéƒ½åˆ·æ–°æ‰å˜›ï¼Œå¥½åƒä¹Ÿä¸æ˜¯ä¸è¡ŒğŸ˜‡ã€‚çªç„¶æƒ³åˆ°æ˜¯ä¸æ˜¯ä»–æœ‰å¯èƒ½å…¶å®æ˜¯æ”¯æŒçš„ï¼Œä½†æ˜¯åªæ˜¯æ–‡æ¡£æ²¡æœ‰æ›´æ–°è€Œå·²ï¼Œäºæ˜¯å°±å°è¯•åœ¨ä¼ å‚é‡Œé¢å¸¦ä¸Š urlsï¼ŒæŠŠæˆ‘éœ€è¦åˆ·æ–°çš„ url ä¼ è¿‡å»çœ‹å¯ä¸å¯ä»¥ã€‚

```bash
curl -v --request POST \
	--url https://api.cloudflare.com/client/v4/zones/identifier/purge_cache \
	--header 'Content-Type: application/json' \
	--header "X-Auth-Email: $AUTH_EMAIL" \
	--header "X-Auth-Key: $CLOUDFLARE_API_KEY" \
	--data '{
	"urls": [
	"https://assets.example.com/download/App-windows-latest.zip",
	"https://assets.example.com/download/App-macOS-latest.zip",
	"https://assets.example.com/download/App-macOS-arm64-latest.zip"
	]
}'
```

é‚£ä¸å‡ºæ‰€æ–™ï¼Œæ²¡æœ‰æˆåŠŸğŸ˜‡ã€‚ä½†æ˜¯ä»–å´è¿”å›äº†å…³é”®ä¿¡æ¯ï¼Œå‘Šè¯‰äº†æˆ‘æœ‰å“ªäº›å‚æ•°æ˜¯åˆæ³•çš„ï¼Œè€Œä¸æ˜¯å°±ä¸€ä¸ªå¾ˆæŠ½è±¡çš„æŠ¥é”™ï¼Œè¯´æˆ‘å‚æ•°é”™è¯¯ğŸ¤¯ã€‚

![cloudflare-purge-cache-error-message](purge-cache-error.png)

å¤šäºäº†è¿™ä¸ªå…³é”®çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘æŠŠ urls æ¢æˆ files åï¼Œè¯·æ±‚å°±æˆåŠŸäº†ï¼Œåé¢è¯•ç€ä¸‹äº†ä¸€ä¸ªæ–°çš„ä¹ŸæˆåŠŸçš„éªŒè¯åˆ°æ–°çš„ commit ç”Ÿæ•ˆğŸ‰

![cloudflare-purge-cache-success-message](purge-cache-success.png)

è¦æ˜¯è¿™ä¸ª API è¿”å›æ¥çš„é”™è¯¯ä¿¡æ¯æ˜¯ä»€ä¹ˆ Invalid Param æˆ–è€… Internal Server Error ä¹‹ç±»çš„é‚£ä¼°è®¡åˆè¦åœ¨ç½‘ä¸Šæ‰¾åŠå¤©å¯èƒ½æ‰ä¼šæ‰¾åˆ°ç­”æ¡ˆå§ ğŸ¤£


## Reference
[CDN](https://en.wikipedia.org/wiki/Content_delivery_network)

[Amazon CloudFront](https://aws.amazon.com/cloudfront/)

[Purge Cached Content](https://developers.cloudflare.com/api/operations/zone-purge)
